<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sistema Profesional de Etiquetas</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
:root{
 --w:100mm;
 --h:150mm;
 --gap:2mm;
 --bg:#f8fafc;
 --panel:#ffffff;
 --text:#0f172a;
 --border:#cbd5e1;
 --btn:#06b6d4;
 --btnHover:#0891b2;
}

*{box-sizing:border-box;font-family:Arial}
body{margin:0;display:flex;min-height:100vh;background:var(--bg)}
aside{width:360px;padding:20px;background:#fff;border-right:1px solid var(--border);overflow:auto}
main{flex:1;padding:20px;background:#eef2f7}

label{font-size:13px;margin-top:8px;display:block}
input,textarea,select{
 width:100%;padding:8px;margin-top:2px;
 border-radius:6px;border:1px solid var(--border);
}
button{
 width:100%;padding:12px;margin-top:12px;
 border:none;border-radius:8px;
 background:var(--btn);color:#fff;cursor:pointer;
}

#preview{display:flex;flex-direction:column;align-items:center}

/* PAGE */
.page{
 width:210mm;
 height:297mm;
 display:flex;
 flex-direction:column;
 page-break-after:always;
 position:relative;
}

/* MEDIA HOJA */
.sheet-2 .page::after{
 content:"";
 position:absolute;
 top:50%;
 left:10mm;
 right:10mm;
 border-top:2px dashed #9ca3af;
}

.label{
 width:var(--w);
 height:var(--h);
 background:#fff;
 margin-bottom:var(--gap);
 page-break-inside:avoid;
 overflow:hidden;
}

.inner{
 height:100%;
 padding:8mm;
 display:flex;
 flex-direction:column;
 gap:2mm;
}

.empresa{text-align:center;font-size:26px;font-weight:900}
.pedido{text-align:center;font-size:30px;font-weight:900}
.bulto{text-align:center;font-size:26px;font-weight:900}
.qr{display:flex;justify-content:center}

.field{
 display:grid;
 grid-template-columns:150px 1fr;
 column-gap:10px;
 font-size:16px;
}
.field .label-txt{font-weight:900}
.field .value{font-weight:600;word-break:break-word}

@page{margin:0}
@media print{
 aside{display:none}
 body{background:#fff}
}

</style>
</head>

<body>

<aside>
<h2>Etiquetas Logísticas</h2>

<label>Empresa</label><input id="empresa">

<label>Formato</label>
<select id="mode">
 <option value="thermal">Térmica</option>
 <option value="sheet">A4 automático</option>
 <option value="sheet-2">A4 media hoja (2)</option>
</select>

<label>Pedido</label><input id="pedido">
<label>Cliente</label><input id="cliente">
<label>Dirección</label><textarea id="direccion"></textarea>
<label>Comuna</label><input id="comuna">
<label>Transporte</label><input id="transporte">
<label>Bultos</label><input id="bultos" type="number" value="1">
<label>Observaciones</label><textarea id="obs"></textarea>

<label>Ancho (mm)</label><input id="w" type="number" value="100">
<label>Alto (mm)</label><input id="h" type="number" value="150">

<button onclick="guardarEImprimir()">Guardar / Imprimir</button>
</aside>

<main>
<div id="preview"></div>
</main>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbyGluMuRIE4Bo_P9wVYUhT5bN-I132uYnbdU7u6W15Oi5QQD3nOF_QBfoeUyGAGpkK2Tw/exec";
const preview=document.getElementById("preview");

function generar(){
 preview.innerHTML="";
 preview.className=mode.value;

 const esMedia=mode.value==="sheet-2";
 const esThermal=mode.value==="thermal";

 if(esMedia){ w.value=210; h.value=148.5 }

 document.documentElement.style.setProperty("--w",w.value+"mm");
 document.documentElement.style.setProperty("--h",h.value+"mm");

 const total=+bultos.value||1;
 const porPagina = esThermal?1 : esMedia?2 : total;

 let page;

 for(let i=1;i<=total;i++){
  if(i===1||(i-1)%porPagina===0){
   page=document.createElement("div");
   page.className="page";
   preview.appendChild(page);
  }

  const l=document.createElement("div");
  l.className="label";

  l.innerHTML=`
   <div class="inner">
    <div class="empresa">${empresa.value}</div>
    <div class="qr"></div>
    <div class="pedido">${pedido.value}</div>
    <div class="bulto">BULTO ${i}/${total}</div>

    <div class="field"><span class="label-txt">CLIENTE:</span><span class="value">${cliente.value}</span></div>
    <div class="field"><span class="label-txt">DIRECCIÓN:</span><span class="value">${direccion.value}</span></div>
    <div class="field"><span class="label-txt">COMUNA:</span><span class="value">${comuna.value}</span></div>
    <div class="field"><span class="label-txt">TRANSPORTE:</span><span class="value">${transporte.value}</span></div>
    <div class="field"><span class="label-txt">OBS:</span><span class="value">${obs.value}</span></div>
   </div>
  `;

  page.appendChild(l);

  new QRCode(l.querySelector(".qr"),{
   text:pedido.value,
   width:110,
   height:110
  });
 }
}

function guardarEImprimir(){
 generar();

 // GUARDAR EN SEGUNDO PLANO (NO BLOQUEA)
 fetch(API_URL,{
   method:"POST",
   body:JSON.stringify({
     action:"add",
     EMPRESA:empresa.value,
     PEDIDO:pedido.value,
     CLIENTE:cliente.value,
     DIRECCION:direccion.value,
     COMUNA:comuna.value,
     TRANSPORTE:transporte.value,
     ETIQUETAS:+bultos.value,
     OBSERVACIONES:obs.value,
     STATUS:"PENDIENTE"
   })
 }).catch(()=>{});

 // IMPRIME SIEMPRE
 setTimeout(()=>{
   window.print();
 },400);
}

["empresa","pedido","cliente","direccion","comuna","transporte","bultos","obs","mode"]
.forEach(id=>document.getElementById(id).addEventListener("input",generar));

generar();
</script>

</body>
</html>
